<sup>Версия гайда: 3.1 (25.12.2024), написано данянулом \<3
Первоисточник: https://t.me/nb_mods/16782/21399
Перезалил v1s7 (11.01.2025)</sup>
[Switch to English](https://github.com/v1s7/csv-monsters/blob/main/MANUAL-en.md)

-----
**В данной заметке представлена основная информация, необходимая для создания собственных модификаций для Null's Brawl.**

Разделы:
```table-of-contents
title: 
style: nestedList # Стиль содержания (nestedList|nestedOrderedList|inlineFirstLevel)
minLevel: 0 
maxLevel: 0 
includeLinks: true 
hideWhenEmpty: false 
debugInConsole: false 
```
# I. Общие правила
Но начнем мы... с правил. Они довольно просты, но, к сожалению, не всем очевидны.
- Название и описание модификации должны быть осмысленными и понятными (без грамматических ошибок)
- Нецензурная брань в названии и описании запрещены (в самом моде допустимы, если это уместно)
- Описание должно наиболее полно описывать вносимые изменения (в том числе побочные эффекты при их наличии)
- В случае заимствования контента из других модификаций или источников, рекомендуется указывать их (в авторстве или в описании)
- Вам не стоит изменять тексты игры с целью указания авторства или рекламы (авторство указывается отдельно в самой модификации)

Также отдельно **строго запрещено** :
- Нарушать работоспособность игры
- Вносить изменения, которые не предполагаются из описания

В случае намеренной разработки или распространения модификаций, нарушающих правила, администрация может полностью ограничить нарушителям возможности по созданию модификаций и/или применить иные меры по своему усмотрению.

# II. Игровые файлы и их структура
Модификации нацелены, в первую очередь, на изменение игровых файлов. Поэтому рассмотрим их структуру.

## Общая структура папок и файлов игры 
Все базовые (необходимые для работы игры) текстуры, звуки, таблицы и прочие файлы хранятся в папке assets в APK, либо в папке res в IPA файле. В свою очередь, они тоже разложены по папкам:
- **csv_logic** : таблицы в формате csv, описывающие поведение и клиента, и сервера
- **csv_client** : таблицы в формате csv, относящиеся к поведению только клиента
- **localizations** : таблицы в формате csv, содержащие все тексты в игре для различных языков
- **sc** : 2D-текстуры и анимации в проприетарном формате (существуют open-source редакторы разного качества)
- **sc3d** : 3D-текстуры, модели и анимации в различных форматах (glb, scw, png, etc.)
- **json** : файлы с описанием некоторых физических аспектов моделей персонажей
- **music** : фоновая музыка
- **sfx** : звуки и звуковые эффекты
- **fingerprint.json** : необходим для скачивания файлов с сервера (подробнее будет ниже)

Также существуют и другие папки и файлы, которые редко представляют интерес для моддинга.

### Таблицы 
Что касается таблиц, то о них стоит поговорить поподробнее. Хранятся они в формате **.csv** (значения разделяются запятыми), по одной таблице в каждом файле.

В большинстве случаев таблицы описывают отдельный тип объектов. Например, **projectiles.csv** описывает все существующие в игре снаряды. Первая колонка таблицы, **Name** , определяет название объекта, все последующие определяют присущие ему значения.

Эти значения могут иметь следующие типы данных:
- Числовые (int)
- Логические (boolean)
- Строковые (string)
- Ссылочные: частный случай, когда строка является названием объекта из этой же или другой таблицы (например: "CocoonerCocoon" в колонке SpawnCharacter)
- Пути: частный случай, когда строка является путем или названием какого-либо файла (например: "sc/effects.sc" в колонке FileName)

Более того, некоторые таблицы поддерживают списки в качестве значения. В таком случае, список записывается вертикально, каждый новый элемент – на новой безымянной строке. Ярким примером такого будет файл **color_gradients.csv** :

| Name      | Colors   | Speed | Scale |
| --------- | -------- | ----- | ----- |
| String    | String   | int   | int   |
| FreeOffer | FF9FFF72 | 40    | 100   |
|           | FF68E524 |       |       |
|           | FF68E524 |       |       |
|           | FF9FFF72 |       |       |
|           | FFE0FFA0 |       |       |
| ...       | ...      | ...   | ...   |

В данном случае у объекта **FreeOffer** будут такие значения:
- Colors = \[FF9FFF72, FF68E524, FF68E524, FF9FFF72, FFE0FFA0\] (список строк)
- Speed = 40 (число)
- Scale = 100 (число)

А теперь я рекомендую вам посмотреть все таблицы которые есть в игре – и ознакомиться с тем, какие полезные (или нет) данные они в себе хранят. Это интересно, правда :)

### Игровые ресурсы 
Текстуры, музыка, модели... здесь мы не будем касаться того, как они устроены, ведь это потребует отдельного огромного мануала. Важно знать следующее: в таблицах прописаны пути к этим ресурсам. А значит, что мы можем спокойно добавлять и свои файлы – главное указать путь к ним в соответствующих таблицах.

### Серверные патчи 
И еще, что важно иметь в виду: у игры есть механизм, когда она может скачать некоторые файлы с сервера и использовать их **вместо** тех, что лежат в APK (IPA).

Алгоритм, если вкратце, следующий:
1. Игра читает файл **fingerprint.json** , считывая поля **sha** и **version**
2. При входе на сервер игра отправляет поле **sha**
3. Если оно имеет устаревшее значение, сервер отправляет игре новый файл **fingerprint.json** и адрес сервера, откуда можно скачать файлы
4. Игра сверяет значения **sha** для каждого файла, и если оно изменилось – скачивает новую версию файла

Все файлы при этом сохраняются в отдельную папку **update** , которая на Android почти всегда находится по следующему пути: /data/data/{имя пакета}/update.

# III. Модификации и их структура
Начиная с версии 59.197 Null's Brawl имеет в себе отдельный загрузчик модификаций (модлоадер), который вводит несколько собственных концепций работы с файлами.

## NullsBrawlAssets 
Моды распространяются в специальных файлах, формат которых можно описать так:
1. Файл имеет расширение **.NullsBrawlAssets**
2. Файл является Java Archive файлом, то есть обычным ZIP-архивом с папкой META-INF

Более того, в данном архиве могут содержаться следующие файлы:
1. **META-INF/MANIFEST.MF** : обязательный (по спецификации JAR), содержит информацию об архиве, а также требует обязательное поле **Modification-Id** – UUID модификации
2. **content.json** : обязательный, описывает мета-информацию (название, описание, авторство), а также изменения таблиц (подробнее – ниже)
3. **icon.png** : необязательный, является квадратной png-иконкой, которая отображается при установке и в списке модов
4. Различные файлы ресурсов, которые должны быть доступны игре (например: **sc3d/colette_rabbit.scw** )

## Самое главное: content.json 
Практически всегда модификация так или иначе предполагает изменение значений в таблицах. Довольно простым способом могло быть редактирование **.csv** файлов и упаковка их внутрь модификации – но это решение имеет значительное количество недостатков и потенциальные проблемы с совместимостью. Ведь неизвестно, что делать, если несколько модов хотят изменить одну таблицу.

Именно поэтому загрузчик модов **не принимает** файлы таблиц напрямую, а требует описание изменений в файле **content.json**. Фактически, все эти изменения будут применены при запуске игры с учетом всех установленных модов, а также серверного патча.

Итак, теперь давайте рассмотрим саму структуру данного файла:
```json
{
	"@title": "Название мода",
	"@description": "Описание мода",
	"@author": "Разработчик мода",
	"{таблица}": {
		"{строка}": {
			"{колонка}": "{значение}"
		}
	}
}
```
Это может выглядеть немного пугающе, но давайте разбираться.

Первые три строчки содержат мета-информацию: они не влияют на файлы игры. Они необходимы для отображения информации о модификации пользователю: "@title" и "@description" содержат в себе название и описание мода, а "@author" – имя разработчика. А ещё данные поля поддерживают HTML-теги и переход по ссылкам.

Далее идет описание изменений. Это лучше всего показать на примере:
1. Вы захотели отредактировать файл **alliance_roles.csv** – тогда "{таблица}" будет = "alliance_roles" (без расширения .csv)
2. В этом файле вы нашли строчку с названием (Name) **Elder** – тогда "{строка}" будет = "Elder"
3. Вы хотите изменить значение в колонке **CanSendMail** – тогда "{колонка}" будет = "CanSendMail"
4. Вы хотите чтоб новое значение было **true** – тогда "{значение}" будет = true

Итак, у нас получилось следующее:
```json
{
	"alliance_roles": {
		"Elder": {
			"CanSendMail": true
		}
	}
}
```
Не забывайте, что строковые значения пишутся в кавычках! А вот числовые значения или флаги (true / false) можно писать и без них.

Давайте рассмотрим более комплексную модификацию:
```json
{
	"@title": "Тестовый мод",
	"@description": "Этот мод заполняет мега-копилку в клубе, а также визуально позволяет...",
	"@author": "NB modding legend",
	"club_piggy_levels": {
		"PiggyLevel_0_0": {
			"State": 6,
			"ShownLevelInCounter": 5
		}
	},
	"alliance_roles": {
		"Elder": {
			"CanSendMail": true,
			"CanChangeAllianceSettings": true,
			"CanBePromotedToLeader": true,
			"PromoteSkill": 2
		},
		"Member": {
			"CanInvite": true,
			"CanSendMail": true,
			"CanChangeAllianceSettings": true,
			"CanAcceptJoinRequest": true,
			"CanKick": true,
			"CanBePromotedToLeader": true,
			"PromoteSkill": 2
		}
	}
}
```
Как видите, здесь уже изменено несколько строк в нескольких таблицах. Надеюсь, общая идея формата теперь понятна!

Также формат поддерживает добавление новых строк в таблицы. В таком случае просто опишите новую строку с новым названием! Удалять строки, к сожалению, нельзя.

Для написания модов в JSON-формате я рекомендую воспользоваться специальным редактором кода с данным форматом (например, Notepad++). Для проверки синтаксиса можно воспользоваться следующим сайтом: https://jsonlint.com.

Более того, формат еще поддерживает и списки в качестве значений. Подробнее об этом есть в сообщении в чате: https://t.me/nb_mods/1/

## Ой, UUID? 
Да, в файле **MANIFEST.MF** требуется обязательное поле: **Modification-Id** , содержащее уникальный идентификатор по формату UUID: https://ru.wikipedia.org/wiki/UUID#Формат.

Зачем он нужен? Пока только для одной цели: если при установке мода у пользователя уже был мод с таким же UUID, то старый мод удаляется. Это упрощает процесс обновления модов для пользователей.

Сгенерировать UUID можно, например, здесь: https://www.uuidgenerator.net.

## А как же мне собрать собственную модификацию? 
Для начала настоятельно рекомендуется ознакомиться с правилами.

Итак, у вас есть файл content.json, возможно есть дополнительные ресурсы (текстуры или музыка). Как же теперь это всё запаковать?

Каждый мод должен быть подписан. Сделать это можно двумя путями:

### Автоматическая подпись 
В случае, если ваш мод состоит из одного лишь json-файла, не содержит текстур и звуков, вы можете воспользоваться нашим Telegram-ботом.

Для этого отправьте в топик #Signing Requests Lite команду /sign@nulls_mods_bot приложив свой файл. В течение нескольких секунд вы получите готовую и подписанную модификацию!

Если вы не хотите писать сообщения в публичный топик, вы можете так же воспользоваться командой и у бота в личных сообщениях: @nulls_mods_bot.

Помимо отсутствия поддержки дополнительных ресурсов, есть еще некоторые ограничения:
1. Подписанный таким образом файл будет действителен только три дня (после чего установить его будет нельзя)
2. Поле "@author" будет присвоено автоматически (и всегда будет содержать ваш никнейм и Telegram ID)
3. UUID будет сгенерирован автоматически (будет уникальным и постоянным для связки полей "@author" + "@title")
4. Нельзя изменить иконку модификации

Данный способ не рекомендуется, если вы хотите распространять свою модификацию в дальнейшем.

### Ручная подпись
Этот способ вам подойдет если вы готовы распространять свою модификацию среди сообщества, либо если вас не устраивают ограничения автоматической подписи.

Для этого отправьте в топик #Signing Requests Pro свою модификацию в формате ZIP-архива. Такой архив должен содержать в себе файл **content.json** , а также все необходимые игровые ресурсы.

В архив также можно положить файл **icon.png** в соответствии с требованиями.

В сообщении можно указать различные комментарии и пожелания. Также желательно указать UUID – он должен быть новым и уникальным для новых модов, или должен совпадать с UUID предыдущей версии для новых версий существующих модов. Выпускать обновления на чужие моды (без согласия автора) нельзя.

К сожалению, ручная подпись может занимать много времени – до нескольких дней. Более того, мы можем не подписать ваш мод, если он содержит ошибки или сомнительный контент.

## Серверные моды
На данный момент, модификации не загружаются и не поддерживаются на стороне сервера. Любое серверное поведение останется таким же, как было и без них.

Вам не стоит менять значения, которые используются и клиентом, и сервером. Это может привести к тому, что игра будет неправильно обрабатывать поведение сервера. В худшем случае это может привести к неработоспособности игры.

# IV. Дополнительная информация

## Подробнее о работе загрузчика модов
При установке мода, загрузчик распаковывает его файлы по следующему пути: /data/data/{имя
пакета}/mods/{uuid}.

При каждом запуске игры он загружает все распакованные моды, объединяет все изменения в таблицах, и по необходимости обновляет в них значения.

Когда игра обращается к какому-либо файлу, загрузчик проверяет, нет ли этого файла в установленных модах. Если есть – перенаправляет обращение к файлу из мода. Это не касается **.csv** файлов – они будут игнорироваться загрузчиком (поскольку для таблиц действует отдельный механизм).

Если несколько модов содержат файл с одинаковым названием, то поведение загрузчика не определено, перенаправление может произойти к любому из них. Поэтому по возможности рекомендуется называть файлы так, чтобы не конфликтовать с другими модами.

## Требования к иконке (icon.png)
Только PNG формат, квадратная, не более 640x640. Это может быть любое подходящее изображение, но без NSFW.

## Дополнительный формат модификаций (toml)
Возможно, в будущем будет предполагаться поддержка описания мода не только в json-формате
(**content.json**), но и в TOML. Концепция точно такая же, просто другой формат:
```toml
[club_piggy_levels.PiggyLevel_0_0]
State = 6
ShownLevelInCounter = 5

[alliance_roles.Elder]
CanSendMail = true
CanChangeAllianceSettings = true
CanBePromotedToLeader = true
PromoteSkill = 2

[alliance_roles.Member]
CanInvite = true
CanSendMail = true
CanChangeAllianceSettings = true
CanAcceptJoinRequest = true
CanKick = true
CanBePromotedToLeader = true
PromoteSkill = 2
```
